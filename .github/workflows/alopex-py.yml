name: alopex-py

on:
  push:
    paths:
      - ".github/workflows/alopex-py.yml"
      - "crates/alopex-py/**"
  pull_request:
    paths:
      - ".github/workflows/alopex-py.yml"
      - "crates/alopex-py/**"

defaults:
  run:
    shell: bash

jobs:
  numpy:
    name: numpy py${{ matrix.python }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install maturin pytest numpy polars
      - name: Build wheel (numpy)
        run: maturin build -m crates/alopex-py/pyproject.toml --features numpy --release
      - name: Install wheel
        run: python -m pip install --force-reinstall --no-deps target/wheels/*.whl
      - name: Run pytest
        run: pytest crates/alopex-py/tests

  no-numpy:
    name: no-numpy py${{ matrix.python }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install maturin pytest
      - name: Build wheel (no feature)
        run: maturin build -m crates/alopex-py/pyproject.toml --release
      - name: Install wheel
        run: python -m pip install --force-reinstall --no-deps target/wheels/*.whl
      - name: Verify vector APIs are absent
        run: |
          python - <<'PY'
          from alopex import Database, Transaction

          txn_missing = [
              "upsert_vector",
              "search_similar",
              "upsert_to_hnsw",
              "delete_from_hnsw",
          ]
          db_missing = [
              "create_hnsw_index",
              "search_hnsw",
              "drop_hnsw_index",
              "get_hnsw_stats",
          ]

          for name in txn_missing:
              assert not hasattr(Transaction, name), f"{name} should be absent"
          for name in db_missing:
              assert not hasattr(Database, name), f"{name} should be absent"
          PY
