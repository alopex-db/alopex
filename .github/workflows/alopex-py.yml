name: alopex-py

on:
  push:
    branches: [main, develop]
    paths:
      - ".github/workflows/alopex-py.yml"
      - "crates/alopex-py/**"
      - "crates/alopex-embedded/**"
      - "crates/alopex-core/**"
  pull_request:
    paths:
      - ".github/workflows/alopex-py.yml"
      - "crates/alopex-py/**"
      - "crates/alopex-embedded/**"
      - "crates/alopex-core/**"

defaults:
  run:
    shell: bash

jobs:
  rust-check:
    name: rust-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cargo fmt
        run: cargo fmt --all -- --check
      - name: Cargo clippy
        run: cargo clippy -p alopex-py --all-targets --all-features

  test:
    name: test ${{ matrix.feature }} py${{ matrix.python }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python: ["3.8", "3.11", "3.13"]
        feature: ["numpy", "no-numpy"]
    steps:
      - name: Checkout
        if: ${{ !env.ACT || (matrix.os == 'ubuntu-latest' && matrix.python == '3.11') }}
        uses: actions/checkout@v4
      - name: Setup Python
        if: ${{ !env.ACT }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Setup Rust
        if: ${{ !env.ACT || (matrix.os == 'ubuntu-latest' && matrix.python == '3.11') }}
        uses: dtolnay/rust-toolchain@stable
      - name: Setup virtualenv
        if: ${{ !env.ACT || (matrix.os == 'ubuntu-latest' && matrix.python == '3.11') }}
        run: |
          python_cmd="python"
          if [[ -n "${ACT:-}" ]]; then
            python_cmd="python3"
          fi
          rm -rf .venv
          "$python_cmd" -m venv .venv
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            venv_bin=".venv/Scripts"
          else
            venv_bin=".venv/bin"
          fi
          echo "VIRTUAL_ENV=$PWD/.venv" >> "$GITHUB_ENV"
          echo "$PWD/$venv_bin" >> "$GITHUB_PATH"
      - name: Install base dependencies
        if: ${{ !env.ACT || (matrix.os == 'ubuntu-latest' && matrix.python == '3.11') }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install maturin pytest
      - name: Install numpy
        if: ${{ (!env.ACT || (matrix.os == 'ubuntu-latest' && matrix.python == '3.11')) && matrix.feature == 'numpy' }}
        run: |
          if [[ -n "${ACT:-}" ]]; then
            python -m pip install numpy
            exit 0
          fi
          python -m pip install numpy
      - name: Install patchelf (Linux)
        if: ${{ !env.ACT || (matrix.os == 'ubuntu-latest' && matrix.python == '3.11') }}
        run: |
          if [[ "${{ matrix.os }}" != "ubuntu-latest" ]]; then
            exit 0
          fi
          if command -v patchelf &> /dev/null; then
            exit 0
          fi
          if command -v sudo &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y patchelf
            exit 0
          fi
          apt-get update
          apt-get install -y patchelf
      - name: Maturin develop
        if: ${{ !env.ACT || (matrix.os == 'ubuntu-latest' && matrix.python == '3.11') }}
        run: |
          if [[ -n "${ACT:-}" ]]; then
            if [[ "${{ matrix.feature }}" == "numpy" ]]; then
              maturin develop -m crates/alopex-py/Cargo.toml --features numpy
            else
              maturin develop -m crates/alopex-py/Cargo.toml
            fi
            exit 0
          fi
          if [[ "${{ matrix.feature }}" == "numpy" ]]; then
            maturin develop -m crates/alopex-py/Cargo.toml --features numpy
          else
            maturin develop -m crates/alopex-py/Cargo.toml
          fi
      - name: Run pytest
        if: ${{ !env.ACT || (matrix.os == 'ubuntu-latest' && matrix.python == '3.11') }}
        run: |
          if [[ -n "${ACT:-}" ]]; then
            python -m pytest crates/alopex-py/tests -k "not benchmark"
            exit 0
          fi
          pytest crates/alopex-py/tests
      - name: Verify vector APIs are absent
        if: ${{ (!env.ACT || (matrix.os == 'ubuntu-latest' && matrix.python == '3.11')) && matrix.feature == 'no-numpy' }}
        run: |
          python - <<'PY'
          from alopex import Database, Transaction

          txn_missing = [
              "upsert_vector",
              "search_similar",
              "upsert_to_hnsw",
              "delete_from_hnsw",
          ]
          db_missing = [
              "create_hnsw_index",
              "search_hnsw",
              "drop_hnsw_index",
              "get_hnsw_stats",
          ]

          for name in txn_missing:
              assert not hasattr(Transaction, name), f"{name} should be absent"
          for name in db_missing:
              assert not hasattr(Database, name), f"{name} should be absent"
          PY

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        if: ${{ !env.ACT }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install mypy
        run: |
          if [[ -n "${ACT:-}" ]]; then
            python3 -m venv .venv
            echo "VIRTUAL_ENV=$PWD/.venv" >> "$GITHUB_ENV"
            echo "$PWD/.venv/bin" >> "$GITHUB_PATH"
            source .venv/bin/activate
            python -m pip install --upgrade pip
            python -m pip install mypy
            exit 0
          fi
          python -m pip install --upgrade pip
          python -m pip install mypy
      - name: Run mypy
        run: |
          if [[ -n "${ACT:-}" ]]; then
            python3 -m mypy crates/alopex-py/python/alopex
            exit 0
          fi
          mypy crates/alopex-py/python/alopex

  benchmarks:
    name: benchmarks (small/medium)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        if: ${{ !env.ACT }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Setup virtualenv
        run: |
          python_cmd="python"
          if [[ -n "${ACT:-}" ]]; then
            python_cmd="python3"
          fi
          rm -rf .venv
          "$python_cmd" -m venv .venv
          echo "VIRTUAL_ENV=$PWD/.venv" >> "$GITHUB_ENV"
          echo "$PWD/.venv/bin" >> "$GITHUB_PATH"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install maturin pytest pytest-benchmark numpy
      - name: Install patchelf (Linux)
        run: |
          if command -v patchelf &> /dev/null; then
            exit 0
          fi
          if command -v sudo &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y patchelf
            exit 0
          fi
          apt-get update
          apt-get install -y patchelf
      - name: Maturin develop (numpy)
        run: |
          maturin develop -m crates/alopex-py/Cargo.toml --features numpy
      - name: Run benchmarks
        run: |
          pytest crates/alopex-py/tests/benchmarks/ -v --benchmark-only --benchmark-json=benchmark.json -m "not large"
      - name: Upload benchmark artifact
        uses: actions/upload-artifact@v4
        with:
          name: alopex-py-benchmark-${{ github.run_id }}-${{ github.run_attempt }}
          path: benchmark.json

  ci-success:
    name: ci-success
    if: ${{ always() }}
    needs: [rust-check, test, typecheck, benchmarks]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.rust-check.result }}" != "success" ]]; then
            exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            exit 1
          fi
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            exit 1
          fi
          if [[ "${{ needs.benchmarks.result }}" != "success" ]]; then
            exit 1
          fi
