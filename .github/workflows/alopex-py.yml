name: alopex-py

on:
  push:
    branches: [main, develop]
    paths:
      - ".github/workflows/alopex-py.yml"
      - "crates/alopex-py/**"
      - "crates/alopex-embedded/**"
      - "crates/alopex-core/**"
  pull_request:
    paths:
      - ".github/workflows/alopex-py.yml"
      - "crates/alopex-py/**"
      - "crates/alopex-embedded/**"
      - "crates/alopex-core/**"

defaults:
  run:
    shell: bash

jobs:
  rust-check:
    name: rust-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cargo fmt
        run: cargo fmt --all -- --check
      - name: Cargo clippy
        run: cargo clippy -p alopex-py --all-targets --all-features

  test:
    name: test ${{ matrix.feature }} py${{ matrix.python }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python: ["3.8", "3.11", "3.13"]
        feature: ["numpy", "no-numpy"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install base dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install maturin pytest
      - name: Install numpy
        if: matrix.feature == 'numpy'
        run: python -m pip install numpy
      - name: Maturin develop
        run: |
          if [[ "${{ matrix.feature }}" == "numpy" ]]; then
            maturin develop -m crates/alopex-py/pyproject.toml --features numpy
          else
            maturin develop -m crates/alopex-py/pyproject.toml
          fi
      - name: Run pytest
        run: pytest crates/alopex-py/tests
      - name: Verify vector APIs are absent
        if: matrix.feature == 'no-numpy'
        run: |
          python - <<'PY'
          from alopex import Database, Transaction

          txn_missing = [
              "upsert_vector",
              "search_similar",
              "upsert_to_hnsw",
              "delete_from_hnsw",
          ]
          db_missing = [
              "create_hnsw_index",
              "search_hnsw",
              "drop_hnsw_index",
              "get_hnsw_stats",
          ]

          for name in txn_missing:
              assert not hasattr(Transaction, name), f"{name} should be absent"
          for name in db_missing:
              assert not hasattr(Database, name), f"{name} should be absent"
          PY

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install mypy
        run: |
          python -m pip install --upgrade pip
          python -m pip install mypy
      - name: Run mypy
        run: mypy crates/alopex-py/python/alopex

  ci-success:
    name: ci-success
    if: ${{ always() }}
    needs: [rust-check, test, typecheck]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.rust-check.result }}" != "success" ]]; then
            exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            exit 1
          fi
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            exit 1
          fi
